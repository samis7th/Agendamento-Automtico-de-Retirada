{
  "name": "Disparo de mensagens para Clientes - Sanitizado",
  "nodes": [
    {
      "parameters": {
        "operation": "getAll",
        "documentId": "{{GOOGLE_SHEET_ID_CLIENTES}}",
        "sheetName": "{{GOOGLE_SHEET_TAB}}",
        "options": {}
      },
      "type": "n8n-nodes-base.googleSheets",
      "typeVersion": 4.7,
      "position": [80, 0],
      "name": "Dados Clientes"
    },
    {
      "parameters": {
        "conditions": {
          "options": {},
          "conditions": [
            {
              "leftValue": "={{ $json.Telefone }}",
              "operator": { "type": "boolean", "operation": "isEmpty" }
            }
          ]
        }
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [448, 0],
      "name": "If"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "position": [768, -192],
      "name": "Não faz nada"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.splitInBatches",
      "position": [1072, 16],
      "name": "Loop para tabela"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            { "name": "Nome", "value": "={{ $json.Nome }}", "type": "string" },
            { "name": "Telefone", "value": "={{ $json.Telefone }}", "type": "string" },
            { "name": "enderecoCliente", "value": "={{ $json.Endereço }}", "type": "string" }
          ]
        }
      },
      "type": "n8n-nodes-base.set",
      "position": [-176, 240],
      "name": "Formata itens"
    },
    {
      "parameters": {
        "jsCode": "return items.map(item => {\n  let tel = item.json.Telefone || \"\";\n  tel = tel.replace(/\\D/g, \"\");\n  if (tel.startsWith(\"0\")) tel = tel.slice(1);\n  if (!tel.startsWith(\"55\")) tel = \"55\" + tel;\n  item.json.Telefone = \"+\" + tel;\n  const nome = item.json.Nome ? item.json.Nome.split(\" \")[0] : \"\";\n  const endereco = item.json.enderecoCliente || \"{endereço}\";\n  const mensagem =\n`Olá ${nome}, somos da Desktop Internet. \nEstamos entrando em contato porque precisamos agendar a retirada do equipamento que ficou no endereço ${endereco}. \nEssa retirada é importante para não haver cobranças futuras. \nPodemos agendar uma data para retirada?`;\n  item.json.Mensagem = mensagem.replace(/\\n/g, '\\\\n');\n  return item;\n})"
      },
      "type": "n8n-nodes-base.code",
      "position": [80, 240],
      "name": "Formata telefone e mensagem"
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://api.z-api.io/instances/{{ZAPI_INSTANCE_ID}}/token/{{ZAPI_TOKEN}}/send-text",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={ \"phone\": \"{{ $json.Telefone }}\", \"message\": \"{{ $json.Mensagem }}\" }"
      },
      "type": "n8n-nodes-base.httpRequest",
      "position": [352, 240],
      "name": "Envia Mensagem"
    },
    {
      "parameters": {},
      "type": "n8n-nodes-base.noOp",
      "position": [1072, 240],
      "name": "Replace Me"
    },
    {
      "parameters": {
        "amount": 3
      },
      "type": "n8n-nodes-base.wait",
      "position": [1264, 240],
      "name": "Espera próximo item"
    },
    {
      "parameters": {
        "operation": "update",
        "documentId": "{{GOOGLE_SHEET_ID_ENVIO}}",
        "sheetName": "{{GOOGLE_SHEET_TAB}}",
        "columns": {
          "mappingMode": "defineBelow",
          "value": {
            "Telefone": "={{ $json.Telefone }}",
            "Tentativas": "={{ $json.Tentativas }}"
          },
          "matchingColumns": ["Telefone"]
        }
      },
      "type": "n8n-nodes-base.googleSheets",
      "position": [832, 240],
      "name": "Dados de Envio"
    }
  ],
  "connections": {
    "Dados Clientes": { "main": [{ "node": "If", "type": "main" }] },
    "If": {
      "main": [
        [{ "node": "Não faz nada", "type": "main" }],
        [{ "node": "Loop para tabela", "type": "main" }]
      ]
    },
    "Loop para tabela": {
      "main": [
        [],
        [{ "node": "Formata itens", "type": "main" }]
      ]
    },
    "Formata itens": {
      "main": [
        [{ "node": "Formata telefone e mensagem", "type": "main" }]
      ]
    },
    "Formata telefone e mensagem": {
      "main": [
        [{ "node": "Envia Mensagem", "type": "main" }]
      ]
    },
    "Envia Mensagem": {
      "main": [
        [{ "node": "Dados de Envio", "type": "main" }]
      ]
    },
    "Dados de Envio": {
      "main": [
        [{ "node": "Replace Me", "type": "main" }]
      ]
    },
    "Replace Me": {
      "main": [
        [{ "node": "Espera próximo item", "type": "main" }]
      ]
    },
    "Espera próximo item": {
      "main": [
        [{ "node": "Loop para tabela", "type": "main" }]
      ]
    }
  },
  "active": false
}
